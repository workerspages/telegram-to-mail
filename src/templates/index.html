<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>Telegram 配置中心</title>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="container">
  <header class="main-header">
    <h2>Telegram 配置中心</h2>
    <div class="header-actions">
      <button class="btn btn-primary" onclick="openAddGroupModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        <span>添加群组</span>
      </button>
      <button class="btn-icon" onclick="openNotifierModal()" title="推送通道设置">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
      </button>
       <button class="btn-icon" onclick="logout()" title="退出登录">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
      </button>
    </div>
  </header>

  <main id="groupList"></main>
</div>

<!-- 推送通道配置弹窗 -->
<div id="notifierModalMask" class="modal-mask">
  <div class="modal">
    <div class="modal-header">
      <h2>推送通道设置</h2>
      <button class="close" onclick="closeNotifierModal()">&times;</button>
    </div>
    <form id="notifierForm">
      <div class="modal-body">
        <div class="notifier-section">
          <h4>Email (SMTP)</h4>
          <div class="form-group"><label for="msmtp_host">Host</label><input id="msmtp_host"></div>
          <div class="form-group"><label for="msmtp_port">Port</label><input id="msmtp_port"></div>
          <div class="form-group"><label for="msmtp_user">User</label><input id="msmtp_user"></div>
          <div class="form-group"><label for="msmtp_pass">Password</label><input id="msmtp_pass" type="password"></div>
          <div class="form-group"><label for="msmtp_from">From Address</label><input id="msmtp_from"></div>
        </div>
        <div class="notifier-section">
          <h4>Bark</h4>
          <div class="form-group">
            <label for="bark_server_url">服务器地址 (留空则使用公共服务器)</label>
            <input id="bark_server_url" placeholder="例如: https://bark.yourdomain.com">
          </div>
          <div id="barkTokenList"></div>
          <button type="button" class="btn btn-secondary btn-small" onclick="addGlobalToken('bark')">添加 Bark Token</button>
        </div>
        <div class="notifier-section">
          <h4>Pushplus Tokens</h4>
          <div id="pushTokenList"></div>
          <button type="button" class="btn btn-secondary btn-small" onclick="addGlobalToken('pushplus')">添加 Pushplus Token</button>
        </div>
      </div>
      <div class="modal-status">
        <span id="notifierStatus"></span>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeNotifierModal()">取消</button>
        <button type="submit" class="btn btn-primary">保存通道设置</button>
      </div>
    </form>
  </div>
</div>

<!-- 添加/编辑群组弹窗 -->
<div id="addGroupModalMask" class="modal-mask">
  <div class="modal">
     <div class="modal-header">
      <h2>添加新群组</h2>
      <button class="close" onclick="closeAddGroupModal()">&times;</button>
    </div>
    <form id="addGroupForm">
      <div class="modal-body">
        <div class="form-group"><label for="modalGroupId">群组ID</label><input type="text" id="modalGroupId" required placeholder="例如: -1001234567890"></div>
        <div class="form-group"><label for="modalGroupName">群组名称 (备注)</label><input type="text" id="modalGroupName" placeholder="例如: 公司技术交流群"></div>
        <div class="form-group">
          <label>默认推送通道</label>
          <div id="modalDefaultNotifyContainer" class="checkbox-group"></div>
        </div>
        <div class="form-group">
          <label>关键字推送 (可选)</label>
          <div id="addGroupKeywords"></div>
          <button type="button" class="btn btn-secondary btn-small" onclick="addKeywordRow()">添加关键字</button>
        </div>
      </div>
       <div class="modal-status">
        <span class="error-msg" id="addGroupError"></span>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeAddGroupModal()">取消</button>
        <button type="submit" class="btn btn-primary">保存</button>
      </div>
    </form>
  </div>
</div>

<script>
let configData = {{ config|tojson|safe }};
const pushTypes = { bark: "Bark", pushplus: "Pushplus", email: "Email" };

// ---------- 核心：保存配置到服务器 ----------
async function saveConfigToServer() {
    try {
        const response = await fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(configData)
        });
        return response.ok;
    } catch (error) {
        console.error("Failed to save config:", error);
        return false;
    }
}

// ---------- 展开/折叠功能 ----------
function toggleGroup(idx) {
    const card = document.getElementById(`group-card-${idx}`);
    if (card) {
        card.classList.toggle('expanded');
    }
}

// ---------- 全局函数 ----------
function getAvailableNotifiers() {
    let options = [{ id: 'email', name: 'Email' }];
    if (configData.notifiers.bark && configData.notifiers.bark.tokens) {
        configData.notifiers.bark.tokens.forEach(n => options.push({ id: n.id, name: `${pushTypes.bark}-${n.id}` }));
    }
    if (configData.notifiers.pushplus) {
        configData.notifiers.pushplus.forEach(n => options.push({ id: n.id, name: `${pushTypes.pushplus}-${n.id}` }));
    }
    return options;
}

// ---------- 弹窗管理 ----------
function openNotifierModal(){
    document.getElementById('notifierStatus').textContent = '';
    renderNotifierModal(); 
    document.getElementById('notifierModalMask').classList.add('active'); 
}
function closeNotifierModal(){ document.getElementById('notifierModalMask').classList.remove('active'); }

function openAddGroupModal(){
  document.getElementById('addGroupForm').reset();
  document.getElementById('addGroupModalMask').classList.add('active');
  document.getElementById('addGroupError').textContent="";
  renderModalDefaultNotify([]);
  renderKeywordRows([]);
}
function closeAddGroupModal(){ document.getElementById('addGroupModalMask').classList.remove('active'); }

// ---------- 推送通道弹窗渲染 ----------
function renderNotifierModal(){
  let n = configData.notifiers;
  // Email
  document.getElementById('msmtp_host').value = n.email.msmtp_host||'';
  document.getElementById('msmtp_port').value = n.email.msmtp_port||'';
  document.getElementById('msmtp_user').value = n.email.msmtp_user||'';
  document.getElementById('msmtp_pass').value = n.email.msmtp_pass||'';
  document.getElementById('msmtp_from').value = n.email.msmtp_from||'';

  // Bark
  const barkConfig = n.bark || { server_url: '', tokens: [] };
  document.getElementById('bark_server_url').value = barkConfig.server_url || '';
  const barkTokenContainer = document.getElementById('barkTokenList');
  barkTokenContainer.innerHTML = (barkConfig.tokens || []).map((t, idx) => `
    <div class="token-row">
      <input type="text" value="${t.token}" placeholder="输入 Bark Key" onchange="updateGlobalToken('bark', ${idx}, this.value)">
      <span class="id-tag">ID: ${t.id}</span>
      <button type="button" class="btn-icon" onclick="removeGlobalToken('bark', ${idx})" title="删除Token">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
      </button>
    </div>`).join('');

  // Pushplus
  const pushplusTokenContainer = document.getElementById('pushTokenList');
  pushplusTokenContainer.innerHTML = (n.pushplus || []).map((t, idx) => `
    <div class="token-row">
      <input type="text" value="${t.token}" placeholder="输入 Pushplus Token" onchange="updateGlobalToken('pushplus', ${idx}, this.value)">
      <span class="id-tag">ID: ${t.id}</span>
      <button type="button" class="btn-icon" onclick="removeGlobalToken('pushplus', ${idx})" title="删除Token">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
      </button>
    </div>`).join('');
}

function addGlobalToken(type){
  if (type === 'bark') {
    if (!configData.notifiers.bark) configData.notifiers.bark = { server_url: '', tokens: [] };
    const barkTokens = configData.notifiers.bark.tokens;
    let nextId = `bark${barkTokens.length + 1}`;
    barkTokens.push({id: nextId, token: ''});
  } else { // pushplus
    if (!configData.notifiers.pushplus) configData.notifiers.pushplus = [];
    const pushplusTokens = configData.notifiers.pushplus;
    let nextId = `pushplus${pushplusTokens.length + 1}`;
    pushplusTokens.push({id: nextId, token: ''});
  }
  renderNotifierModal();
}
function removeGlobalToken(type, idx){
  if (type === 'bark') {
    configData.notifiers.bark.tokens.splice(idx, 1);
  } else {
    configData.notifiers.pushplus.splice(idx, 1);
  }
  renderNotifierModal();
}
function updateGlobalToken(type, idx, value){
  if (type === 'bark') {
    configData.notifiers.bark.tokens[idx].token = value;
  } else {
    configData.notifiers.pushplus[idx].token = value;
  }
}

// ---------- 群组列表主渲染 ----------
function renderGroups(expandedIndex = -1) {
  let groups = configData.groups;
  let html = '';
  if (groups.length === 0) {
    html = `<div class="group-card" style="text-align:center; color: var(--text-light); padding: 3rem;">暂无群组配置，请点击“添加群组”进行设置。</div>`;
  } else {
    groups.forEach((group, idx) => {
      const isExpanded = idx === expandedIndex;
      html += `<div class="group-card ${isExpanded ? 'expanded' : ''}" id="group-card-${idx}">
        <div class="group-card-header" onclick="toggleGroup(${idx})">
          <div class="toggle-container">
            <div class="toggle-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
          </div>
          <div class="group-title">
            ${group.name || '未命名群组'}
            <span>[ID: ${group.id}]</span>
          </div>
          <div class="header-controls">
            <button class="btn-icon" onclick="deleteGroup(event, ${idx})" title="删除群组">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--danger-color);"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
          </div>
        </div>
        <div class="group-card-body">
            <div class="form-group">
              <label>默认推送通道</label>
              ${createNotifierCheckboxes(`group-${idx}-default`, group.default_notifiers || [], `updateGroupNotifier(${idx})`)}
            </div>
            <div class="form-group">
              <label>关键字推送</label>
              <div id="kwlist-${idx}">
                ${(group.keywords || []).map((kw, kidx) => createKeywordRow(idx, kidx, kw)).join('')}
              </div>
              <button type="button" class="btn btn-secondary btn-small" onclick="addKeywordToGroup(${idx})" style="margin-top: 0.5rem;">添加关键字</button>
            </div>
        </div>
      </div>`;
    });
  }
  document.getElementById('groupList').innerHTML = html;
}

function createNotifierCheckboxes(containerId, selectedValues = [], onchangeCallback = '') {
    const options = getAvailableNotifiers();
    const checkboxesHtml = options.map(opt => `
        <label>
            <input type="checkbox" value="${opt.id}" name="${containerId}" 
                   ${selectedValues.includes(opt.id) ? 'checked' : ''}
                   onchange="${onchangeCallback}">
            ${opt.name}
        </label>
    `).join('');
    return `<div id="${containerId}" class="checkbox-group">${checkboxesHtml}</div>`;
}

async function updateGroupNotifier(groupIdx) {
    const containerId = `group-${groupIdx}-default`;
    const checked = Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(el => el.value);
    configData.groups[groupIdx].default_notifiers = checked;
    await saveConfigToServer();
}
async function updateKeywordNotifier(groupIdx, kidx) {
    const containerId = `group-${groupIdx}-kw-${kidx}`;
    const checked = Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(el => el.value);
    configData.groups[groupIdx].keywords[kidx].notifiers = checked;
    await saveConfigToServer();
}

function createKeywordRow(groupIdx, kidx, kwObj){
  const containerId = `group-${groupIdx}-kw-${kidx}`;
  return `<div class="keyword-block">
    <div class="keyword-input-row">
      <input type="text" value="${kwObj.word||''}" placeholder="输入关键字" onchange="updateKeywordWord(${groupIdx}, ${kidx}, this.value)">
      <button type="button" class="btn-icon" onclick="removeKeyword(${groupIdx}, ${kidx})" title="删除关键字"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
    </div>
    <div class="keyword-notifiers">
      ${createNotifierCheckboxes(containerId, kwObj.notifiers || [], `updateKeywordNotifier(${groupIdx}, ${kidx})`)}
    </div>
  </div>`;
}
async function addKeywordToGroup(groupIdx){
  if(!configData.groups[groupIdx].keywords) configData.groups[groupIdx].keywords=[];
  configData.groups[groupIdx].keywords.push({word:'', notifiers:[]});
  if (await saveConfigToServer()) {
    renderGroups(groupIdx);
  }
}
async function updateKeywordWord(groupIdx, kidx, val){ 
    configData.groups[groupIdx].keywords[kidx].word = val.trim(); 
    await saveConfigToServer();
}
async function removeKeyword(groupIdx, kidx){ 
    configData.groups[groupIdx].keywords.splice(kidx,1); 
    if (await saveConfigToServer()) {
        renderGroups(groupIdx);
    }
}
async function deleteGroup(event, idx) {
    event.stopPropagation();
    if (confirm('确定要删除这个群组的配置吗？此操作不可恢复。')) {
        configData.groups.splice(idx, 1);
        if (await saveConfigToServer()) {
            renderGroups();
        }
    }
}

// ---------- 添加群组弹窗逻辑 ----------
function renderModalDefaultNotify(selectedValues){
  const container = document.getElementById('modalDefaultNotifyContainer');
  container.innerHTML = getAvailableNotifiers().map(opt => `
      <label>
          <input type="checkbox" value="${opt.id}" name="modal-default-notify"
                 ${selectedValues.includes(opt.id) ? 'checked' : ''}>
          ${opt.name}
      </label>
  `).join('');
}
let addGroupKeywords = [];
function renderKeywordRows(keywords){
  addGroupKeywords = keywords;
  let kwDiv = document.getElementById('addGroupKeywords');
  kwDiv.innerHTML = keywords.map((kw, idx) => `
    <div class="keyword-block">
      <div class="keyword-input-row">
        <input type="text" value="${kw.word||''}" onchange="updateNewKeywordWord(${idx}, this.value)" placeholder="输入关键字">
        <button type="button" class="btn-icon" onclick="removeKeywordRow(${idx})"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
      </div>
      <div class="keyword-notifiers">
        ${createNewKeywordNotifyCheckboxes(idx, kw.notifiers||[])}
      </div>
    </div>`
  ).join('');
}
function createNewKeywordNotifyCheckboxes(kidx, vals){
  const containerId = `modal-kw-${kidx}`;
  const onchange = `updateNewKeywordNotify(${kidx})`;
  return createNotifierCheckboxes(containerId, vals, onchange);
}
function addKeywordRow(){ addGroupKeywords.push({word:'', notifiers:[]}); renderKeywordRows(addGroupKeywords); }
function removeKeywordRow(idx){ addGroupKeywords.splice(idx, 1); renderKeywordRows(addGroupKeywords); }
function updateNewKeywordWord(idx, val){ addGroupKeywords[idx].word = val.trim(); }
function updateNewKeywordNotify(idx){
  const containerId = `modal-kw-${idx}`;
  addGroupKeywords[idx].notifiers = Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(el => el.value);
}

// ---------- 表单提交与保存 ----------
document.getElementById('addGroupForm').onsubmit = async function(e){
  e.preventDefault();
  const errorSpan = document.getElementById('addGroupError');
  const gid = document.getElementById('modalGroupId').value.trim();
  const name = document.getElementById('modalGroupName').value.trim();
  const defaultNotify = Array.from(document.querySelectorAll('#modalDefaultNotifyContainer input:checked')).map(el => el.value);
  if(!gid) { errorSpan.textContent="群组ID是必填项。"; return; }
  if(configData.groups.some(g => g.id === gid)) { errorSpan.textContent="该群组ID已存在，请勿重复添加。"; return; }
  
  const newGroup = {
    id: gid, name: name, default_notifiers: defaultNotify,
    keywords: JSON.parse(JSON.stringify(addGroupKeywords))
  };
  configData.groups.push(newGroup);
  
  if (await saveConfigToServer()) {
    const newIndex = configData.groups.length - 1;
    closeAddGroupModal();
    renderGroups(newIndex);
  } else {
    errorSpan.textContent = "保存失败，请检查网络或服务。";
    configData.groups.pop(); // Revert change if save fails
  }
};

document.getElementById('notifierForm').onsubmit = async function(e){
  e.preventDefault();
  const statusSpan = document.getElementById('notifierStatus');
  statusSpan.textContent = "正在保存...";
  statusSpan.style.color = 'var(--text-light)';

  const oldNotifiers = JSON.parse(JSON.stringify(configData.notifiers));
  
  configData.notifiers.email = {
    msmtp_host: document.getElementById('msmtp_host').value, msmtp_port: document.getElementById('msmtp_port').value,
    msmtp_user: document.getElementById('msmtp_user').value, msmtp_pass: document.getElementById('msmtp_pass').value,
    msmtp_from: document.getElementById('msmtp_from').value
  };

  configData.notifiers.bark.server_url = document.getElementById('bark_server_url').value.trim();

  if (await saveConfigToServer()) {
      statusSpan.textContent = "保存成功！";
      statusSpan.style.color = 'var(--success-color)';
      setTimeout(() => {
          closeNotifierModal();
          renderGroups();
      }, 1000);
  } else {
      statusSpan.textContent = "保存失败，配置已回滚。";
      statusSpan.style.color = 'var(--danger-color)';
      configData.notifiers = oldNotifiers; // Rollback
  }
};

function logout(){ location.href="/logout"; }

// ---------- 初始渲染 ----------
renderGroups();
</script>
</body>
</html>

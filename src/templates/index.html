<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>Telegram 群组监听与推送配置管理</title>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .modal-mask { position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(33,61,82,.15); z-index:1000; display:flex; justify-content:center; align-items:center; }
    .modal { background:#fff; border-radius:8px; box-shadow:0 2px 12px #3332; max-width:480px; width:96vw; padding:32px 24px; position:relative; }
    .modal h2 {margin-top:0;}
    .modal .close {position:absolute;right:12px;top:7px;font-size:18px;cursor:pointer;}
    .group-card { border: 1px solid #eee; border-radius: 5px; padding: 15px; margin-bottom: 20px;}
    .btn {padding: 6px 22px; border-radius: 4px; border: none; background: #4CAF50; color: #fff;}
    button[disabled], .btn[disabled] {background: #ccc;}
    .btn-danger {background:#f44336;}
    .btn-secondary {background: #2b89d9;}
    .btn-small {padding:4px 10px; font-size:14px;}
    .keyword-row {display:flex; gap:10px; margin-bottom:6px;}
    .keyword-row input {flex:1;}
    .token-row {display:flex; gap:10px; align-items:center; margin-bottom:6px;}
    .token-row input {flex:1;}
    .flush-right {text-align:right;}
    .flex-between {display:flex; justify-content:space-between; align-items:center;}
    .error-msg {color:#d32f2f; font-size:14px;}
    .success-msg {color:#388E3C; font-size:14px;}
    @media (max-width:540px){
      .modal{padding:10px;}
      .group-card {padding:6px;}
    }
  </style>
</head>
<body>
<div class="container" style="max-width:900px;margin:32px auto 24px auto;background:#fff;padding:24px 8vw 16px 8vw; border-radius:10px; box-shadow:0 2px 9px #eee;">
  <div class="flex-between">
    <h2>Telegram 群组监听与推送配置</h2>
    <button class="btn btn-secondary btn-small" onclick="logout()">退出登录</button>
  </div>
  <div class="flush-right" style="margin-bottom:10px;">
    <button class="btn btn-secondary btn-small" onclick="openNotifierModal()">推送通道设置</button>
    <button class="btn btn-small" onclick="openAddGroupModal()">添加群组</button>
  </div>
  <div id="groupList"></div>
  <div class="flush-right" style="margin-top:32px;">
    <button class="btn" onclick="saveAllConfig()">保存所有配置</button>
    <span class="error-msg" id="saveError"></span>
    <span class="success-msg" id="saveSuccess"></span>
  </div>
</div>

<!-- 推送通道配置弹窗 -->
<div id="notifierModalMask" class="modal-mask" style="display:none;">
  <div class="modal">
    <span class="close" onclick="closeNotifierModal()">&times;</span>
    <h2>推送通道设置</h2>
    <form id="notifierForm">
      <div><label>Email Host</label> <input id="msmtp_host" required></div>
      <div><label>Email Port</label> <input id="msmtp_port" required></div>
      <div><label>Email User</label> <input id="msmtp_user" required></div>
      <div><label>Email Pass</label> <input id="msmtp_pass" required type="password"></div>
      <div><label>Email From</label> <input id="msmtp_from" required></div>
      <div style="margin-top:1em;">
        <b>Bark Tokens：</b>
        <div id="barkTokenList"></div>
        <button type="button" class="btn btn-small btn-secondary" onclick="addGlobalToken('bark')">添加Bark Token</button>
      </div>
      <div style="margin-top:1em;">
        <b>Pushplus Tokens：</b>
        <div id="pushTokenList"></div>
        <button type="button" class="btn btn-small btn-secondary" onclick="addGlobalToken('pushplus')">添加Pushplus Token</button>
      </div>
      <div class="flush-right" style="margin-top:14px;">
        <button type="submit" class="btn">保存通道</button>
      </div>
      <div class="error-msg" id="notifierError"></div>
      <div class="success-msg" id="notifierSuccess"></div>
    </form>
  </div>
</div>

<!-- 添加群组弹窗，支持推送通道/关键字推送配置 -->
<div id="addGroupModalMask" class="modal-mask" style="display:none;">
  <div class="modal" style="max-width:600px;">
    <span class="close" onclick="closeAddGroupModal()">&times;</span>
    <h2>添加群组</h2>
    <form id="addGroupForm">
      <div><label>群组ID</label> <input type="text" id="modalGroupId" required placeholder="如-1001234567890"></div>
      <div><label>群组名称</label> <input type="text" id="modalGroupName" placeholder="群组名称"></div>
      <div>
        <label>默认推送通道</label>
        <select id="modalDefaultNotify" multiple></select>
      </div>
      <div><b>关键字推送配置：</b>
        <div id="addGroupKeywords"></div>
        <button type="button" class="btn btn-small btn-secondary" onclick="addKeywordRow()">添加关键字</button>
      </div>
      <div class="flush-right" style="margin-top:12px;">
        <button type="submit" class="btn">保存</button>
        <button type="button" class="btn btn-danger" onclick="closeAddGroupModal()">取消</button>
      </div>
      <div class="error-msg" id="addGroupError"></div>
    </form>
  </div>
</div>

<script>
let configData = {{ config|tojson|safe }};
const pushTypes = { bark: "Bark", pushplus: "Pushplus", email: "Email" };

// 弹窗管理
function openNotifierModal(){ renderNotifierModal(); document.getElementById('notifierModalMask').style.display='flex'; }
function closeNotifierModal(){ document.getElementById('notifierModalMask').style.display='none'; }
function openAddGroupModal(){ document.getElementById('addGroupModalMask').style.display='flex'; document.getElementById('addGroupError').textContent=""; renderModalDefaultNotify(); renderKeywordRows([]); }
function closeAddGroupModal(){ document.getElementById('addGroupModalMask').style.display='none'; }

// 推送通道弹窗渲染
function renderNotifierModal(){
  let n = configData.notifiers;
  document.getElementById('msmtp_host').value = n.email.msmtp_host||'';
  document.getElementById('msmtp_port').value = n.email.msmtp_port||'';
  document.getElementById('msmtp_user').value = n.email.msmtp_user||'';
  document.getElementById('msmtp_pass').value = n.email.msmtp_pass||'';
  document.getElementById('msmtp_from').value = n.email.msmtp_from||'';
  let barkList = document.getElementById('barkTokenList');
  barkList.innerHTML = '';
  n.bark.forEach((t, idx) => {
    barkList.innerHTML += `<div class="token-row">
      <input type="text" value="${t.token}" onchange="updateGlobalToken('bark',${idx},this.value)">
      <span style="color:#999;">id:${t.id}</span>
      <button type="button" class="btn btn-small btn-danger" onclick="removeGlobalToken('bark',${idx})">删除</button>
    </div>`;
  });
  let pushList = document.getElementById('pushTokenList');
  pushList.innerHTML = '';
  n.pushplus.forEach((t, idx) => {
    pushList.innerHTML += `<div class="token-row">
      <input type="text" value="${t.token}" onchange="updateGlobalToken('pushplus',${idx},this.value)">
      <span style="color:#999;">id:${t.id}</span>
      <button type="button" class="btn btn-small btn-danger" onclick="removeGlobalToken('pushplus',${idx})">删除</button>
    </div>`;
  });
}
function addGlobalToken(type){
  let nextId = type + (configData.notifiers[type].length + 1);
  configData.notifiers[type].push({id:nextId,token:''});
  renderNotifierModal();
}
function removeGlobalToken(type, idx){
  configData.notifiers[type].splice(idx,1);
  renderNotifierModal();
}
function updateGlobalToken(type, idx, value){
  configData.notifiers[type][idx].token = value;
}

// 群组列表主渲染
function renderGroups(){
  let g = configData.groups;
  let html = '';
  g.forEach((group, idx) => {
    html += `<div class="group-card">
      <div class="flex-between">
        <span><b>${group.name||''}</b> <span style="color:#999;">[${group.id}]</span></span>
        <button class="btn btn-small btn-danger" onclick="deleteGroup(${idx})">删除群组</button>
      </div>
      <div>默认推送通道:
        ${createNotifierSelect('default_notifiers',idx,group.default_notifiers||[])}
      </div>
      <div>
        <b>关键字推送配置：</b>
        <div id="kwlist-${idx}">
          ${(group.keywords||[]).map((kw,kidx)=>createKeywordRow(idx,kidx,kw)).join('')}
        </div>
        <button class="btn btn-small btn-secondary" onclick="addKeywordToGroup(${idx})">添加关键字</button>
      </div>
    </div>`;
  });
  document.getElementById('groupList').innerHTML = html;
}
function createNotifierSelect(type, groupIdx, valArr) {
  let notis = configData.notifiers;
  let opts = [];
  for(let t in notis) notis[t].forEach(n=>opts.push({id:n.id,type:t}));
  opts.push({id:'email',type:'email'});
  return `<select multiple onchange="updateGroupNotifier('${type}',${groupIdx},this)">
    ${opts.map(o=>`<option value="${o.id}"${valArr.includes(o.id)?' selected':''}>${pushTypes[o.type]}-${o.id}</option>`).join('')}
  </select>`;
}
function updateGroupNotifier(type, groupIdx, sel) {
  const vals = Array.from(sel.selectedOptions).map(x=>x.value);
  configData.groups[groupIdx][type] = vals;
}
function addKeywordToGroup(groupIdx){
  if(!configData.groups[groupIdx].keywords) configData.groups[groupIdx].keywords=[];
  configData.groups[groupIdx].keywords.push({word:'',notifiers:[]});
  renderGroups();
}
function createKeywordRow(groupIdx, kidx, kwObj){
  return `<div class="keyword-row">
    <input type="text" value="${kwObj.word||''}" placeholder="关键字" onchange="updateKeywordWord(${groupIdx},${kidx},this.value)">
    ${createNotifierSelect(`keywords[${kidx}].notifiers`,groupIdx,kwObj.notifiers||[])}
    <button class="btn btn-small btn-danger" onclick="removeKeyword(${groupIdx},${kidx})">删除</button>
  </div>`;
}
function updateKeywordWord(groupIdx, kidx, val){
  configData.groups[groupIdx].keywords[kidx].word = val;
}
function removeKeyword(groupIdx, kidx){
  configData.groups[groupIdx].keywords.splice(kidx,1);
  renderGroups();
}
function deleteGroup(idx){
  configData.groups.splice(idx,1);
  renderGroups();
}

// ---------- 添加群组弹窗支持推送、关键字 ----------
function renderModalDefaultNotify(){
  let sel = document.getElementById('modalDefaultNotify');
  sel.innerHTML = '';
  let opts = [];
  for(let t in configData.notifiers) configData.notifiers[t].forEach(n=>opts.push({id:n.id,type:t}));
  opts.push({id:'email',type:'email'});
  for(let o of opts){
    let opt = document.createElement('option');
    opt.value = o.id;
    opt.text = (pushTypes[o.type]||o.type) + '-' + o.id;
    sel.appendChild(opt);
  }
}
let addGroupKeywords = [];
function renderKeywordRows(keywords){
  addGroupKeywords = keywords;
  let kwDiv = document.getElementById('addGroupKeywords');
  kwDiv.innerHTML = '';
  keywords.forEach((kw, idx)=>{
    kwDiv.innerHTML += `<div class="keyword-row">
      <input type="text" value="${kw.word||''}" onchange="updateNewKeywordWord(${idx},this.value)" placeholder="关键字">
      ${createNewKeywordNotifySelect(idx,kw.notifiers||[])}
      <button type="button" class="btn btn-small btn-danger" onclick="removeKeywordRow(${idx})">删除</button>
    </div>`;
  });
}
function addKeywordRow(){
  addGroupKeywords.push({word:'',notifiers:[]});
  renderKeywordRows(addGroupKeywords);
}
function updateNewKeywordWord(idx,val){ addGroupKeywords[idx].word = val;}
function createNewKeywordNotifySelect(kidx,vals){
  let opts = [];
  for(let t in configData.notifiers) configData.notifiers[t].forEach(n=>opts.push({id:n.id,type:t}));
  opts.push({id:'email',type:'email'});
  return `<select multiple onchange="updateNewKeywordNotify(${kidx},this)">` +
    opts.map(o=>`<option value="${o.id}"${vals.includes(o.id)?' selected':''}>${pushTypes[o.type]}-${o.id}</option>`).join('') +
    `</select>`;
}
function updateNewKeywordNotify(idx,sel){
  addGroupKeywords[idx].notifiers = Array.from(sel.selectedOptions).map(x=>x.value);
}
function removeKeywordRow(idx){
  addGroupKeywords.splice(idx,1);
  renderKeywordRows(addGroupKeywords);
}
document.getElementById('addGroupForm').onsubmit = function(e){
  e.preventDefault();
  let gid = document.getElementById('modalGroupId').value.trim();
  let name = document.getElementById('modalGroupName').value.trim();
  let defaultNotify = Array.from(document.getElementById('modalDefaultNotify').selectedOptions).map(x=>x.value);
  if(!gid){
    document.getElementById('addGroupError').textContent="群组ID必填";
    return;
  }
  if(configData.groups.some(g=>g.id==gid)){
    document.getElementById('addGroupError').textContent="群组ID已存在";
    return;
  }
  configData.groups.push({
    id: gid,
    name: name,
    default_notifiers: defaultNotify,
    keywords: JSON.parse(JSON.stringify(addGroupKeywords))
  });
  closeAddGroupModal();
  renderGroups();
};

// 推送通道表单提交
document.getElementById('notifierForm').onsubmit = async function(e){
  e.preventDefault();
  let n = configData.notifiers;
  n.email={
    msmtp_host:document.getElementById('msmtp_host').value,
    msmtp_port:document.getElementById('msmtp_port').value,
    msmtp_user:document.getElementById('msmtp_user').value,
    msmtp_pass:document.getElementById('msmtp_pass').value,
    msmtp_from:document.getElementById('msmtp_from').value
  };
  try {
    let resp = await fetch('/api/notifiers', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(n)
    });
    if(resp.ok){
      document.getElementById('notifierSuccess').textContent="保存成功";
      document.getElementById('notifierError').textContent="";
    } else {
      document.getElementById('notifierError').textContent="保存失败";
      document.getElementById('notifierSuccess').textContent="";
    }
    setTimeout(closeNotifierModal, 1200);
  } catch(e) {
    document.getElementById('notifierError').textContent="请求错误";
    document.getElementById('notifierSuccess').textContent="";
  }
};

// 全局保存
function saveAllConfig(){
  document.getElementById('saveError').textContent="";
  document.getElementById('saveSuccess').textContent="";
  fetch('/api/config', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(configData)
  }).then(r=>{
    if(r.ok) {
      document.getElementById('saveSuccess').textContent="保存成功";
      setTimeout(()=>{document.getElementById('saveSuccess').textContent=""},1800);
    } else {
      document.getElementById('saveError').textContent="保存失败";
    }
  }).catch(()=>{ document.getElementById('saveError').textContent="请求出错"; });
}
function logout(){ location.href="/logout"; }

renderGroups();

</script>
</body>
</html>
